name: Extract OpenVINO (Final Minimal Release)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest
    steps:
      - name: Download Official Packages
        run: |
          mkdir -p downloads
          echo ">>> Downloading Windows Package..."
          curl -L -o downloads/win.zip "https://storage.openvinotoolkit.org/repositories/openvino/packages/2023.3/windows/w_openvino_toolkit_windows_2023.3.0.13775.ceeafaf64f3_x86_64.zip"
          
          echo ">>> Downloading Mac Package..."
          curl -L -o downloads/mac.tgz "https://storage.openvinotoolkit.org/repositories/openvino/packages/2023.3/macos/m_openvino_toolkit_macos_10_15_2023.3.0.13775.ceeafaf64f3_x86_64.tgz"

      - name: Extract Archives
        run: |
          echo ">>> Extracting..."
          unzip -q downloads/win.zip -d extracted_win
          mkdir -p extracted_mac
          tar -xzf downloads/mac.tgz -C extracted_mac
          
          # 获取动态根目录名
          WIN_ROOT=$(find extracted_win -maxdepth 1 -type d -name "w_openvino*" | head -n 1)
          MAC_ROOT=$(find extracted_mac -maxdepth 1 -type d -name "m_openvino*" | head -n 1)
          
          echo "WIN_ROOT=$WIN_ROOT" >> $GITHUB_ENV
          echo "MAC_ROOT=$MAC_ROOT" >> $GITHUB_ENV

      # --- Windows 处理 (GPU Only + ONNX Only + Minimal TBB) ---
      - name: Process Windows Runtime
        run: |
          mkdir -p final_output/windows
          
          SRC_BIN="$WIN_ROOT/runtime/bin/intel64/Release"
          SRC_TBB="$WIN_ROOT/runtime/3rdparty/tbb/bin"
          SRC_INC="$WIN_ROOT/runtime/include/ie/c_api"
          DST="final_output/windows"
          
          echo ">>> Copying Windows Libraries..."
          
          # 1. 核心库 & ONNX
          cp "$SRC_BIN/openvino.dll" "$DST/"
          cp "$SRC_BIN/openvino_c.dll" "$DST/"
          cp "$SRC_BIN/openvino_onnx_frontend.dll" "$DST/"
          
          # 2. 插件 (仅保留 Intel GPU)
          cp "$SRC_BIN/openvino_intel_gpu_plugin.dll" "$DST/"
          # GPU 编译缓存配置 (推荐保留，否则初始化很慢)
          [ -f "$SRC_BIN/cache.json" ] && cp "$SRC_BIN/cache.json" "$DST/"
          
          # 3. [严格精简] TBB 依赖库
          # 仅复制 tbb12.dll 和 tbbmalloc.dll
          # 排除 proxy, bind 和 debug 版本
          echo ">>> Copying Minimal TBB (No bind/proxy/debug)..."
          cp "$SRC_TBB"/tbb12.dll "$DST/"
          cp "$SRC_TBB"/tbbmalloc.dll "$DST/"
          
          # 4. C API 头文件
          mkdir -p "$DST/include"
          cp "$SRC_INC/ie_c_api.h" "$DST/include/"
          
          # 5. 生成 Windows 专用 plugins.xml
          echo ">>> Generating Windows plugins.xml..."
          cat <<EOF > "$DST/plugins.xml"
          <ie>
              <plugins>
                  <plugin name="GPU" location="openvino_intel_gpu_plugin.dll">
                  </plugin>
              </plugins>
          </ie>
          EOF

      # --- Mac 处理 (CPU Only + ONNX Only + Minimal TBB + Patch) ---
      - name: Process Mac Runtime
        run: |
          mkdir -p final_output/mac
          
          SRC_LIB="$MAC_ROOT/runtime/lib/intel64/Release"
          SRC_TBB="$MAC_ROOT/runtime/3rdparty/tbb/lib"
          SRC_INC="$MAC_ROOT/runtime/include/ie/c_api"
          DST="final_output/mac"
          
          echo ">>> Copying Mac Libraries..."
          
          # 1. 核心库 & ONNX
          cp "$SRC_LIB/libopenvino.dylib" "$DST/"
          cp "$SRC_LIB/libopenvino_c.dylib" "$DST/"
          cp "$SRC_LIB/libopenvino_onnx_frontend.dylib" "$DST/"
          
          # 2. 插件 (仅保留 CPU)
          # 自动识别 .so 或 .dylib
          CPU_PLUGIN=$(find "$SRC_LIB" -name "libopenvino_intel_cpu_plugin.*" | head -n 1)
          cp "$CPU_PLUGIN" "$DST/"
          CPU_PLUGIN_NAME=$(basename "$CPU_PLUGIN")
          
          # 3. [严格精简] TBB 依赖库
          # 明确指定版本号，避免重复拷贝软链接
          echo ">>> Copying Minimal TBB (Core + Malloc Only)..."
          cp "$SRC_TBB"/libtbb.12.dylib "$DST/"
          cp "$SRC_TBB"/libtbbmalloc.2.dylib "$DST/"
          
          # 4. C API 头文件
          mkdir -p "$DST/include"
          cp "$SRC_INC/ie_c_api.h" "$DST/include/"
          
          # 5. 生成 Mac 专用 plugins.xml
          echo ">>> Generating Mac plugins.xml..."
          cat <<EOF > "$DST/plugins.xml"
          <ie>
              <plugins>
                  <plugin name="CPU" location="$CPU_PLUGIN_NAME">
                  </plugin>
              </plugins>
          </ie>
          EOF

          # 6. [关键] Mac 本地化 Patch (修改 @rpath 为 @loader_path)
          echo ">>> Patching Mac binaries for local execution..."
          cd "$DST"
          LIBS=$(ls *.dylib *.so 2>/dev/null)
          
          for LIB in $LIBS; do
            # 赋予写权限
            chmod +w "$LIB"
            
            # A. 修改自身的 ID 为相对路径
            install_name_tool -id "@loader_path/$LIB" "$LIB"
            
            # B. 查找所有 @rpath 依赖并修改为 @loader_path
            # 使用 otool 列出依赖 -> 过滤 -> 提取路径
            DEPS=$(otool -L "$LIB" | grep "@rpath" | awk '{print $1}')
            
            for DEP_PATH in $DEPS; do
                DEP_NAME=$(basename "$DEP_PATH")
                # 核心逻辑：告诉库在当前文件夹(@loader_path)找依赖
                install_name_tool -change "$DEP_PATH" "@loader_path/$DEP_NAME" "$LIB"
                echo "  Fixed dependency: $LIB -> $DEP_NAME"
            done
          done
          
          cd ../..

      - name: Zip and Upload
        run: |
          cd final_output
          zip -r openvino_final_minimal.zip .
          echo ">>> Final Package Contents:"
          ls -R
          
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: openvino_runtime_final
          path: final_output/openvino_final_minimal.zip
