name: Extract OpenVINO (ONNX Only + Minimal + Localized)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest
    steps:
      - name: Download Official Packages
        run: |
          mkdir -p downloads
          echo ">>> Downloading Windows Package..."
          curl -L -o downloads/win.zip "https://storage.openvinotoolkit.org/repositories/openvino/packages/2023.3/windows/w_openvino_toolkit_windows_2023.3.0.13775.ceeafaf64f3_x86_64.zip"
          
          echo ">>> Downloading Mac Package..."
          curl -L -o downloads/mac.tgz "https://storage.openvinotoolkit.org/repositories/openvino/packages/2023.3/macos/m_openvino_toolkit_macos_10_15_2023.3.0.13775.ceeafaf64f3_x86_64.tgz"

      - name: Extract Archives
        run: |
          echo ">>> Extracting..."
          unzip -q downloads/win.zip -d extracted_win
          mkdir -p extracted_mac
          tar -xzf downloads/mac.tgz -C extracted_mac
          
          # 获取解压后的根目录路径
          WIN_ROOT=$(find extracted_win -maxdepth 1 -type d -name "w_openvino*" | head -n 1)
          MAC_ROOT=$(find extracted_mac -maxdepth 1 -type d -name "m_openvino*" | head -n 1)
          
          echo "WIN_ROOT=$WIN_ROOT" >> $GITHUB_ENV
          echo "MAC_ROOT=$MAC_ROOT" >> $GITHUB_ENV

      # --- Windows 处理 (GPU Only + ONNX Only) ---
      - name: Process Windows Runtime
        run: |
          mkdir -p final_output/windows
          
          SRC_BIN="$WIN_ROOT/runtime/bin/intel64/Release"
          SRC_TBB="$WIN_ROOT/runtime/3rdparty/tbb/bin"
          SRC_INC="$WIN_ROOT/runtime/include/ie/c_api"
          DST="final_output/windows"
          
          echo ">>> Copying Windows Libraries..."
          
          # 1. 核心库
          cp "$SRC_BIN/openvino.dll" "$DST/"
          cp "$SRC_BIN/openvino_c.dll" "$DST/"
          
          # 2. 前端支持 (仅 ONNX, 已移除 IR)
          cp "$SRC_BIN/openvino_onnx_frontend.dll" "$DST/"
          
          # 3. 插件 (仅 GPU)
          cp "$SRC_BIN/openvino_intel_gpu_plugin.dll" "$DST/"
          [ -f "$SRC_BIN/cache.json" ] && cp "$SRC_BIN/cache.json" "$DST/"
          
          # 4. 第三方依赖 (TBB)
          cp "$SRC_TBB"/*.dll "$DST/"
          
          # 5. 头文件
          mkdir -p "$DST/include"
          cp "$SRC_INC/ie_c_api.h" "$DST/include/"
          
          # 6. 生成 plugins.xml (Windows GPU)
          echo ">>> Generating Windows plugins.xml..."
          cat <<EOF > "$DST/plugins.xml"
          <ie>
              <plugins>
                  <plugin name="GPU" location="openvino_intel_gpu_plugin.dll">
                  </plugin>
              </plugins>
          </ie>
          EOF

      # --- Mac 处理 (CPU Only + ONNX Only + Patching) ---
      - name: Process Mac Runtime
        run: |
          mkdir -p final_output/mac
          
          SRC_LIB="$MAC_ROOT/runtime/lib/intel64/Release"
          SRC_TBB="$MAC_ROOT/runtime/3rdparty/tbb/lib"
          SRC_INC="$MAC_ROOT/runtime/include/ie/c_api"
          DST="final_output/mac"
          
          echo ">>> Copying Mac Libraries..."
          
          # 1. 核心库
          cp "$SRC_LIB/libopenvino.dylib" "$DST/"
          cp "$SRC_LIB/libopenvino_c.dylib" "$DST/"
          
          # 2. 前端支持 (仅 ONNX, 已移除 IR 修复报错)
          cp "$SRC_LIB/libopenvino_onnx_frontend.dylib" "$DST/"
          
          # 3. 插件 (仅 CPU)
          # 自动寻找 CPU 插件 (兼容 .so 或 .dylib)
          CPU_PLUGIN=$(find "$SRC_LIB" -name "libopenvino_intel_cpu_plugin.*" | head -n 1)
          cp "$CPU_PLUGIN" "$DST/"
          CPU_PLUGIN_NAME=$(basename "$CPU_PLUGIN")
          
          # 4. 第三方依赖 (TBB)
          cp "$SRC_TBB"/libtbb*.dylib "$DST/"
          
          # 5. 头文件
          mkdir -p "$DST/include"
          cp "$SRC_INC/ie_c_api.h" "$DST/include/"
          
          # 6. 生成 plugins.xml (Mac CPU)
          echo ">>> Generating Mac plugins.xml..."
          cat <<EOF > "$DST/plugins.xml"
          <ie>
              <plugins>
                  <plugin name="CPU" location="$CPU_PLUGIN_NAME">
                  </plugin>
              </plugins>
          </ie>
          EOF

          # 7. Mac 本地化 Patch (修改 @rpath 为 @loader_path)
          echo ">>> Patching Mac binaries..."
          cd "$DST"
          LIBS=$(ls *.dylib *.so 2>/dev/null)
          
          for LIB in $LIBS; do
            chmod +w "$LIB"
            # 修改自身 ID
            install_name_tool -id "@loader_path/$LIB" "$LIB"
            
            # 修改依赖路径
            DEPS=$(otool -L "$LIB" | grep "@rpath" | awk '{print $1}')
            for DEP_PATH in $DEPS; do
                DEP_NAME=$(basename "$DEP_PATH")
                install_name_tool -change "$DEP_PATH" "@loader_path/$DEP_NAME" "$LIB"
                echo "  Fixed: $LIB -> $DEP_NAME"
            done
          done
          cd ../..

      - name: Zip and Upload
        run: |
          cd final_output
          zip -r openvino_onnx_only.zip .
          echo "Final Content:"
          ls -R
          
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: openvino_runtime_onnx_only
          path: final_output/openvino_onnx_only.zip
