name: Build-Opencvsharp-Osx-Win-MultiArch-4.10.0

on:
  workflow_dispatch:

jobs:
  # ============================================================
  # Mac Jobs (保留，移除了 lipo_universal)
  # ============================================================
  build_x64:
    runs-on: macos-15-intel
    steps:
      - uses: actions/checkout@v4

      - name: Install tools
        shell: bash
        run: |
          set -euxo pipefail
          brew update
          brew install cmake ninja

      - name: Build x86_64 slice (10.15)
        shell: bash
        run: |
          set -euxo pipefail
          chmod +x .github/scripts/build_macos_slice.sh
          OPENCV_VERSION=4.10.0 OPENCVSHARP_REF=4.11.0.20250507 BUILD_LIST=core,imgproc,videoio \
            .github/scripts/build_macos_slice.sh x86_64 10.15

      - name: Upload x86_64 artifact
        uses: actions/upload-artifact@v4
        with:
          name: osx-x64-slice
          path: _work/out-x86_64/final/libOpenCvSharpExtern.dylib

  build_arm64:
    runs-on: macos-15
    steps:
      - uses: actions/checkout@v4

      - name: Install tools
        shell: bash
        run: |
          set -euxo pipefail
          brew update
          brew install cmake ninja

      - name: Build arm64 slice (11.0)
        shell: bash
        run: |
          set -euxo pipefail
          chmod +x .github/scripts/build_macos_slice.sh
          OPENCV_VERSION=4.10.0 OPENCVSHARP_REF=4.11.0.20250507 BUILD_LIST=core,imgproc,videoio \
            .github/scripts/build_macos_slice.sh arm64 11.0

      - name: Upload arm64 artifact
        uses: actions/upload-artifact@v4
        with:
          name: osx-arm64-slice
          path: _work/out-arm64/final/libOpenCvSharpExtern.dylib

  # ============================================================
  # Windows Matrix Jobs (x64, x86, arm64)
  # ============================================================
  build_windows_matrix:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - target: x64
            arch: x64
            os: windows-latest
            
          - target: x86
            arch: x86
            os: windows-latest
            
          - target: arm64
            # [修改点2] 使用原生架构 arm64 (原 amd64_arm64 是交叉编译)
            arch: arm64
            # [修改点3] 指定 Github 的 ARM Runner
            os: windows-11-arm

    steps:
      - uses: actions/checkout@v4

      # 关键步骤：根据 Matrix 设置正确的 MSVC 环境 (Ninja 必须)
      - uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: ${{ matrix.arch }}

      - name: Install tools (cmake/ninja)
        shell: pwsh
        run: |
          choco install -y ninja cmake
          cmake --version
          ninja --version
          python --version

      - name: Build OpenCvSharpExtern (${{ matrix.target }})
        shell: pwsh
        run: |
          $env:OPENCV_VERSION = "4.10.0"
          $env:OPENCVSHARP_REF = "4.11.0.20250507"
          $env:BUILD_LIST = "core,imgproc,videoio"
          
          # 调用上一条回答中的通用参数化脚本，传入 Matrix 中的 target
          pwsh -File .github/scripts/build_opencv_windows.ps1 -TargetArch ${{ matrix.target }}

      - name: Upload win-${{ matrix.target }} artifact
        uses: actions/upload-artifact@v4
        with:
          name: OpenCvSharpExtern-win-${{ matrix.target }}
          # 路径与脚本中生成的参数化输出目录一致
          path: _work/out-win-${{ matrix.target }}/final/OpenCvSharpExtern.dll
