name: Build-Opencvsharp-Osx-Win-MultiArch-4.10.0

on:
  workflow_dispatch:

jobs:
  build_x64:
    runs-on: macos-15-intel
    steps:
      - uses: actions/checkout@v4

      - name: Install tools
        shell: bash
        run: |
          set -euxo pipefail
          brew update
          brew install cmake ninja

      - name: Build x86_64 slice (10.15)
        shell: bash
        run: |
          set -euxo pipefail
          chmod +x .github/scripts/build_macos_slice.sh
          OPENCV_VERSION=4.10.0 OPENCVSHARP_REF=4.11.0.20250507 BUILD_LIST=core,imgproc,videoio \
            .github/scripts/build_macos_slice.sh x86_64 10.15

      - name: Upload x86_64 artifact
        uses: actions/upload-artifact@v4
        with:
          name: osx-x64-slice
          path: _work/out-x86_64/final/libOpenCvSharpExtern.dylib

  build_arm64:
    runs-on: macos-15
    steps:
      - uses: actions/checkout@v4

      - name: Install tools
        shell: bash
        run: |
          set -euxo pipefail
          brew update
          brew install cmake ninja

      - name: Build arm64 slice (11.0)
        shell: bash
        run: |
          set -euxo pipefail
          chmod +x .github/scripts/build_macos_slice.sh
          OPENCV_VERSION=4.10.0 OPENCVSHARP_REF=4.11.0.20250507 BUILD_LIST=core,imgproc,videoio \
            .github/scripts/build_macos_slice.sh arm64 11.0

      - name: Upload arm64 artifact
        uses: actions/upload-artifact@v4
        with:
          name: osx-arm64-slice
          path: _work/out-arm64/final/libOpenCvSharpExtern.dylib

  build_windows_multi:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      # [Important] 移除了 ilammy/msvc-dev-cmd，脚本会自动处理多架构环境

      - name: Install tools (cmake)
        shell: pwsh
        run: |
          cmake --version
          python --version

      - name: Build OpenCvSharpExtern (Multi-Arch)
        shell: pwsh
        run: |
          $env:OPENCV_VERSION = "4.10.0"
          $env:OPENCVSHARP_REF = "4.11.0.20250507"
          $env:BUILD_LIST = "core,imgproc,videoio"
          
          # 运行支持多架构的脚本
          pwsh -File .github/scripts/build_windows_x64.ps1

      - name: Upload win-x64 artifact
        uses: actions/upload-artifact@v4
        with:
          name: OpenCvSharpExtern-win-x64
          path: _work/final/x64/OpenCvSharpExtern.dll

      - name: Upload win-x86 artifact
        uses: actions/upload-artifact@v4
        with:
          name: OpenCvSharpExtern-win-x86
          path: _work/final/x86/OpenCvSharpExtern.dll

      - name: Upload win-arm64 artifact
        uses: actions/upload-artifact@v4
        with:
          name: OpenCvSharpExtern-win-arm64
          path: _work/final/arm64/OpenCvSharpExtern.dll
