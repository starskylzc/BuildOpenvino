name: Extract Minimal CUDA 12.4 + cuDNN 9.15.1 (Inference Only)

on:
  workflow_dispatch:

jobs:
  extract-minimal:
    runs-on: windows-latest
    steps:
      - name: Prepare Workspace
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force downloads, extracted, final_output\win-x64 | Out-Null

      - name: Download Specific Components
        shell: pwsh
        run: |
          $ProgressPreference = "SilentlyContinue"
          # 定义只包含 4 个核心组件的下载列表
          $urls = @(
            # 1. cudart (Runtime)
            "https://developer.download.nvidia.com/compute/cuda/redist/cuda_cudart/windows-x86_64/cuda_cudart-windows-x86_64-12.4.127-archive.zip",
            
            # 2. cublas (Matrix Math)
            "https://developer.download.nvidia.com/compute/cuda/redist/libcublas/windows-x86_64/libcublas-windows-x86_64-12.4.5.8-archive.zip",
            
            # 3. nvrtc (Runtime Compiler) - 动态编译 CUDA 代码，现代推理必需
            "https://developer.download.nvidia.com/compute/cuda/redist/cuda_nvrtc/windows-x86_64/cuda_nvrtc-windows-x86_64-12.4.127-archive.zip",

            # 4. cuDNN 9.15.1 (Deep Learning Primitives)
            "https://developer.download.nvidia.com/compute/cudnn/redist/cudnn/windows-x86_64/cudnn-windows-x86_64-9.15.1.9_cuda12-archive.zip"
          )

          foreach ($u in $urls) {
            $name = Split-Path $u -Leaf
            Write-Host "Downloading $name ..."
            Invoke-WebRequest -Uri $u -OutFile "downloads\$name"
          }

      - name: Extract Archives
        shell: pwsh
        run: |
          Get-ChildItem downloads\*.zip | ForEach-Object {
            $dest = Join-Path "extracted" $_.BaseName
            Write-Host "Extracting $($_.Name)..."
            Expand-Archive -Path $_.FullName -DestinationPath $dest -Force
          }

      - name: Assemble Minimal DLLs
        shell: pwsh
        run: |
          $dst = "final_output\win-x64"
          
          # === 定义严格的“白名单”文件列表 ===
          $whitelist = @(
            # [cudart] 基础运行时
            "cudart64_12.dll",
            
            # [cublas] 矩阵计算
            "cublas64_12.dll",
            "cublasLt64_12.dll",  # 警告：cublas64_12.dll 强依赖它，不可删除！
            
            # [nvrtc] 运行时编译
            "nvrtc64_120_0.dll",
            "nvrtc-builtins64_124.dll", # 必须配套存在
            
            # [cuDNN] 核心与引擎 (v9 模块化)
            "cudnn64_9.dll",                   # 主入口
            "cudnn_ops64_9.dll",               # 基础算子
            "cudnn_cnn64_9.dll",               # CNN 算子
            "cudnn_graph64_9.dll",             # 图执行
            "cudnn_engines_precompiled64_9.dll",       # 预编译内核 (必须)
            "cudnn_heuristic64_9.dll",                 # 算法选择器 (必须)
            "cudnn_engines_runtime_compiled64_9.dll"   # 运行时编译内核 (建议保留以保证兼容性)
          )

          Write-Host "Searching and copying selected DLLs..."
          
          foreach ($dll in $whitelist) {
            # 在提取目录中递归搜索文件
            $found = Get-ChildItem -Path extracted -Recurse -Filter $dll | Select-Object -First 1
            
            if ($found) {
              Copy-Item -Path $found.FullName -Destination $dst -Force
              Write-Host "  [OK] $($found.Name)"
            } else {
              Write-Error "CRITICAL: Could not find $dll"
              exit 1
            }
          }

      - name: List Final Files
        shell: pwsh
        run: |
          Write-Host "`n=== Final Package Content ==="
          Get-ChildItem "final_output\win-x64" | Sort-Object Name | Format-Table Name, @{N='Size(MB)';E={$_.Length/1MB};f='N2'}

      - name: Pack Zip
        shell: pwsh
        run: |
          $zipName = "cuda12.4_cudnn9.15.1_minimal_infer_win-x64.zip"
          Compress-Archive -Path "final_output\win-x64\*" -DestinationPath $zipName -Force
          echo "ARTIFACT_NAME=$zipName" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: cuda_minimal_infer_libs
          path: ${{ env.ARTIFACT_NAME }}
