name: Extract Cuda 12.4 + cuDNN 9.15.1 (CUDA12) for ORT 1.21.2 (Win10 1809)

on:
  workflow_dispatch:

jobs:
  extract:
    runs-on: windows-latest
    steps:
      - name: Prepare folders
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force downloads, extracted, ort_from_nuget, final_output\win-x64 | Out-Null

      - name: Setup MSVC (for dumpbin)
        uses: ilammy/msvc-dev-cmd@v1

      - name: Download Microsoft.ML.OnnxRuntime.Gpu nupkg (1.21.2)
        shell: pwsh
        env:
          NUPKG_URL: https://globalcdn.nuget.org/packages/microsoft.ml.onnxruntime.gpu.windows.1.21.2.nupkg
        run: |
          $ProgressPreference = "SilentlyContinue"
          $out = "downloads\microsoft.ml.onnxruntime.gpu.windows.1.21.2.nupkg"
          Write-Host ">>> Download nupkg: $env:NUPKG_URL"
          Invoke-WebRequest -Uri $env:NUPKG_URL -OutFile $out
          Expand-Archive -Path $out -DestinationPath ort_from_nuget -Force

      - name: Locate ORT native DLLs
        shell: pwsh
        run: |
          $nativeDir = Get-ChildItem -Recurse ort_from_nuget | Where-Object { $_.FullName -match "runtimes\\win-x64\\native$" -and $_.PSIsContainer } | Select-Object -First 1
          "ORT_NATIVE_DIR=$($nativeDir.FullName)" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8
          Write-Host "ORT_NATIVE_DIR=$($nativeDir.FullName)"
          Write-Host ">>> Native DLLs:"
          Get-ChildItem $nativeDir.FullName -Filter *.dll | Select-Object Name, Length

      - name: Download NVIDIA redistributables (CUDA 12.4 + cuDNN 9.15.1 for CUDA 12)
        shell: pwsh
        run: |
          $ProgressPreference = "SilentlyContinue"
          $urls = @(
            # CUDA 12.4 component redistributables (Windows x86_64)
            "https://developer.download.nvidia.com/compute/cuda/redist/cuda_cudart/windows-x86_64/cuda_cudart-windows-x86_64-12.4.127-archive.zip",  # cudart
            "https://developer.download.nvidia.com/compute/cuda/redist/cuda_cublas/windows-x86_64/cuda_cublas-windows-x86_64-12.4.5.8-archive.zip",  # cuBLAS
            "https://developer.download.nvidia.com/compute/cuda/redist/libcufft/windows-x86_64/libcufft-windows-x86_64-11.2.1.3-archive.zip",  # cuFFT
            "https://developer.download.nvidia.com/compute/cuda/redist/libcurand/windows-x86_64/libcurand-windows-x86_64-10.3.5.147-archive.zip",  # cuRAND
            "https://developer.download.nvidia.com/compute/cuda/redist/libcusolver/windows-x86_64/libcusolver-windows-x86_64-11.6.1.9-archive.zip",  # cuSOLVER
            "https://developer.download.nvidia.com/compute/cuda/redist/libcusparse/windows-x86_64/libcusparse-windows-x86_64-12.4.1.24-archive.zip",  # cuSPARSE

            # cuDNN (CUDA 12 build)
            "https://developer.download.nvidia.com/compute/cudnn/redist/cudnn/windows-x86_64/cudnn-windows-x86_64-9.15.1.9_cuda12-archive.zip",  # cuDNN
            
            # nvrtc (runtime compilation)
            "https://developer.download.nvidia.com/compute/cuda/redist/cuda_nvrtc/windows-x86_64/cuda_nvrtc-windows-x86_64-12.4.127-archive.zip"  # nvrtc
          )
          foreach($u in $urls) {
            $out = Join-Path "downloads" (Split-Path $u -Leaf)
            Write-Host ">>> Downloading $u"
            $retryCount = 3
            $attempt = 0
            while ($attempt -lt $retryCount) {
                try {
                    Invoke-WebRequest -Uri $u -OutFile $out -Verbose
                    Write-Host "Successfully downloaded $u"
                    break
                }
                catch {
                    Write-Host "Error downloading $u. Attempt $($attempt + 1) of $retryCount."
                    $attempt++
                    if ($attempt -eq $retryCount) {
                        throw "Failed to download $u after $retryCount attempts."
                    }
                }
            }
          }

      - name: Extract NVIDIA archives
        shell: pwsh
        run: |
          Get-ChildItem downloads -Filter *.zip | Where-Object { $_.Name -notlike "*.nupkg" } | ForEach-Object {
            $dest = Join-Path "extracted" $_.BaseName
            New-Item -ItemType Directory -Force $dest | Out-Null
            Write-Host ">>> Extracting $($_.Name) -> $dest"
            Expand-Archive -Path $_.FullName -DestinationPath $dest -Force
          }

      - name: Ensure zlibwapi.dll if needed
        shell: pwsh
        run: |
          function deps($dll){ (dumpbin /nologo /dependents $dll) -split "`r?`n" | Where-Object { $_ -match "\.dll$" } }
          $depsSet = @{}
          foreach($p in @(
            "$env:ORT_NATIVE_DIR\onnxruntime_providers_cuda.dll",
            "$env:ORT_NATIVE_DIR\onnxruntime_providers_shared.dll"
          )) { foreach($d in deps($p)){ $depsSet[$d]=1 } }
          if($depsSet["zlibwapi.dll"] -and -not (Test-Path extracted\**\zlibwapi.dll)){
            Invoke-WebRequest -Uri "https://www.winimage.com/zLibDll/zlib123dllx64.zip" -OutFile "downloads\zlib.zip"
            Expand-Archive -Path "downloads\zlib.zip" -DestinationPath "extracted\zlib" -Force
          }

      - name: Analyze CUDA/cuDNN deps with dumpbin
        shell: pwsh
        run: |
          function deps($dll){ (dumpbin /nologo /dependents $dll) -split "`r?`n" | Where-Object { $_ -match "\.dll$" } }
          $allDeps=@()
          foreach($p in @("$env:ORT_NATIVE_DIR\onnxruntime_providers_cuda.dll","$env:ORT_NATIVE_DIR\onnxruntime_providers_shared.dll")) {
            if(Test-Path $p){ $allDeps += deps($p) }
          }
          $allDeps | Sort-Object -Unique | Out-File final_output\win-x64\deps.txt

      - name: Collect minimal CUDA/cuDNN DLLs
        shell: pwsh
        run: |
          $dst="final_output\win-x64"
          Get-Content final_output\win-x64\deps.txt | ForEach-Object {
            if($_ -notlike "nvcuda.dll"){ Copy-Item (Get-ChildItem extracted -Recurse -Filter $_ | Select-Object -First 1).FullName $dst }
          }
          # always include cuDNN
          Get-ChildItem extracted -Recurse -Filter "cudnn*.dll" | ForEach-Object {
            Copy-Item $_.FullName $dst -Force
          }
          # include nvrtc
          Get-ChildItem extracted -Recurse -Filter "nvrtc*.dll" | ForEach-Object {
            Copy-Item $_.FullName $dst -Force
          }
          # include zlib if present
          Get-ChildItem extracted -Recurse -Filter "zlibwapi.dll" | ForEach-Object {
            Copy-Item $_.FullName $dst -Force
          }

      - name: Write manifest & Zip
        shell: pwsh
        run: |
          Get-ChildItem final_output\win-x64 | ForEach-Object { "$($_.Name) `t $($_.Length)" } | Out-File final_output\win-x64\manifest.txt
          Compress-Archive -Path final_output\win-x64\* -DestinationPath final_output\cuda124_cudnn9151_cuda12_infer_win-x64.zip -Force

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: cuda124_cudnn9151_cuda12_infer_win-x64
          path: final_output/cuda124_cudnn9151_cuda12_infer_win-x64.zip
