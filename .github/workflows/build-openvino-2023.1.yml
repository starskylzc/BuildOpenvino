name: "build-openvino-2023.1.0-ort-1.16.0-openvinoep-nuget-no-ort-native"

'on': { workflow_dispatch: {} }

env:
  OPENVINO_TAG: "2023.1.0"
  ORT_TAG: "v1.16.0"
  CONFIG: "Release"

  PACKAGE_ID: "Intel.ML.OnnxRuntime.Openvino"
  PACKAGE_VERSION: "1.16.0"
  ORT_MANAGED_DEP_VERSION: "1.16.0"

  MACOSX_DEPLOYMENT_TARGET: "10.15"

jobs:
  build-win-x64:
    runs-on: windows-2022
    defaults:
      run:
        shell: pwsh
    steps:
      - name: "Setup Python"
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: "Install tools (ninja, vcpkg opencl, python deps)"
        run: |
          $ErrorActionPreference="Stop"
          choco install ninja -y
          git clone --depth 1 https://github.com/microsoft/vcpkg.git vcpkg
          .\vcpkg\bootstrap-vcpkg.bat
          .\vcpkg\vcpkg.exe install opencl:x64-windows
          python -m pip install --upgrade pip
          python -m pip install pefile numpy

      - name: "Clone OpenVINO (tag 2023.1.0)"
        run: |
          $ErrorActionPreference="Stop"
          git clone --branch $env:OPENVINO_TAG --depth 1 --recurse-submodules https://github.com/openvinotoolkit/openvino.git openvino

      - name: "Build & Install OpenVINO (win-x64, Intel GPU plugin ON, no Python)"
        run: |
          $ErrorActionPreference="Stop"

          $vcpkg = Join-Path $env:GITHUB_WORKSPACE "vcpkg"
          $openclLib = Join-Path $vcpkg "installed\x64-windows\lib\OpenCL.lib"
          $openclInc = Join-Path $vcpkg "installed\x64-windows\include"
          if (!(Test-Path $openclLib)) { throw "OpenCL.lib not found: $openclLib" }
          if (!(Test-Path $openclInc)) { throw "OpenCL include not found: $openclInc" }

          cd openvino
          $env:TBBROOT=""
          $env:OpenCV_DIR=""

          New-Item -ItemType Directory -Force -Path build | Out-Null
          cd build

          cmake .. -G "Visual Studio 17 2022" -A x64 `
            -DCMAKE_INSTALL_PREFIX="$PWD\ov_install" `
            -DENABLE_PYTHON=OFF -DENABLE_WHEEL=OFF `
            -DENABLE_TESTS=OFF -DENABLE_SAMPLES=OFF `
            -DENABLE_INTEL_GPU=ON `
            -DOpenCL_LIBRARY="$openclLib" `
            -DOpenCL_INCLUDE_DIR="$openclInc"

          cmake --build . --config $env:CONFIG --parallel
          cmake --install . --config $env:CONFIG

          "$PWD\ov_install" | Out-File -FilePath "$env:GITHUB_WORKSPACE\ov_install_win.txt" -Encoding ascii

      - name: "Clone ONNX Runtime (tag v1.16.0)"
        run: |
          $ErrorActionPreference="Stop"
          git clone --branch $env:ORT_TAG --depth 1 --recurse-submodules https://github.com/microsoft/onnxruntime.git onnxruntime

      - name: "Build ORT OpenVINO EP provider (win-x64, target GPU)"
        run: |
          $ErrorActionPreference="Stop"

          $ov = Get-Content "$env:GITHUB_WORKSPACE\ov_install_win.txt" | Select-Object -First 1
          $ovConfig = Get-ChildItem -Path $ov -Recurse -Filter "OpenVINOConfig.cmake" | Select-Object -First 1
          if (!$ovConfig) { throw "OpenVINOConfig.cmake not found under: $ov" }

          $env:INTEL_OPENVINO_DIR = $ov
          $env:OpenVINO_DIR = $ovConfig.Directory.FullName

          cd onnxruntime
          .\build.bat --config $env:CONFIG --build_shared_lib --parallel --skip_tests --use_openvino GPU --update --build `
            --cmake_generator "Visual Studio 17 2022"

      - name: "Stage minimal win-x64 native payload (no onnxruntime*.dll, dependency-closure BFS)"
        run: |
          $ErrorActionPreference="Stop"

          $pkgRoot = Join-Path $env:GITHUB_WORKSPACE "pkg"
          $native  = Join-Path $pkgRoot "runtimes\win-x64\native"
          New-Item -ItemType Directory -Force -Path $native | Out-Null

          $ov = Get-Content "$env:GITHUB_WORKSPACE\ov_install_win.txt" | Select-Object -First 1
          $vcpkgBin = Join-Path "$env:GITHUB_WORKSPACE\vcpkg" "installed\x64-windows\bin"

          # Provider ONLY (robust search)
          $prov = Get-ChildItem -Path "$env:GITHUB_WORKSPACE\onnxruntime" -Recurse -Filter "onnxruntime_providers_openvino.dll" | Select-Object -First 1
          if (!$prov) { throw "onnxruntime_providers_openvino.dll not found" }
          Copy-Item $prov.FullName $native -Force

          # Seed OpenVINO core + plugins
          $seedNames = @(
            "openvino.dll",
            "openvino_c.dll",
            "openvino_intel_cpu_plugin.dll",
            "openvino_intel_gpu_plugin.dll",
            "openvino_auto_plugin.dll",
            "openvino_multi_plugin.dll",
            "openvino_hetero_plugin.dll",
            "openvino_batch_plugin.dll"
          )
          foreach ($name in $seedNames) {
            $f = Get-ChildItem -Path $ov -Recurse -Filter $name -File | Select-Object -First 1
            if ($f) { Copy-Item $f.FullName $native -Force }
          }

          # Optional OpenCL ICD loader runtime
          $openclDll = Join-Path $vcpkgBin "OpenCL.dll"
          if (Test-Path $openclDll) { Copy-Item $openclDll $native -Force }

          # plugins.xml
          $candidates = @(
            @{ Name="CPU";   File="openvino_intel_cpu_plugin.dll" },
            @{ Name="GPU";   File="openvino_intel_gpu_plugin.dll" },
            @{ Name="AUTO";  File="openvino_auto_plugin.dll" },
            @{ Name="MULTI"; File="openvino_multi_plugin.dll" },
            @{ Name="HETERO";File="openvino_hetero_plugin.dll" },
            @{ Name="BATCH"; File="openvino_batch_plugin.dll" }
          )
          $lines = New-Object System.Collections.Generic.List[string]
          $lines.Add("<ie>")
          $lines.Add("  <plugins>")
          foreach ($p in $candidates) {
            $path = Join-Path $native $p.File
            if (Test-Path $path) { $lines.Add("    <plugin name=`"$($p.Name)`" location=`"$($p.File)`"></plugin>") }
          }
          $lines.Add("  </plugins>")
          $lines.Add("</ie>")
          $lines -join "`r`n" | Out-File -FilePath (Join-Path $native "plugins.xml") -Encoding utf8

          # Write Python script to file (YAML-safe) then run dependency closure BFS
          $pyFile = Join-Path $env:GITHUB_WORKSPACE "dep_closure_win.py"
          $pyLines = @(
            "import os",
            "import pefile",
            "from collections import deque",
            "",
            "native = r'''$native'''",
            "scan_dirs = [r'''$native''', r'''$vcpkgBin''', r'''$ov''']",
            "",
            "def is_system(name):",
            "    u = name.upper()",
            "    sys_prefix = (",
            "        'KERNEL32','USER32','GDI32','ADVAPI32','SHELL32','OLE32','OLEAUT32','WS2_32','IPHLPAPI',",
            "        'CRYPT32','COMDLG32','SHLWAPI','NTDLL','VERSION',",
            "        'MSVCRT','VCRUNTIME','UCRTBASE','api-ms-win-','ext-ms-win-'",
            "    )",
            "    return u.startswith(sys_prefix)",
            "",
            "def is_forbidden(name):",
            "    return name.lower().startswith('onnxruntime')",
            "",
            "def find_dll(name):",
            "    p = os.path.join(native, name)",
            "    if os.path.isfile(p):",
            "        return p",
            "    for d in scan_dirs:",
            "        for root, _, files in os.walk(d):",
            "            for f in files:",
            "                if f.lower() == name.lower():",
            "                    return os.path.join(root, f)",
            "    return None",
            "",
            "def imports(dll_path):",
            "    pe = pefile.PE(dll_path)",
            "    deps = []",
            "    if hasattr(pe, 'DIRECTORY_ENTRY_IMPORT'):",
            "        for entry in pe.DIRECTORY_ENTRY_IMPORT:",
            "            deps.append(entry.dll.decode(errors='ignore'))",
            "    return deps",
            "",
            "queue = deque()",
            "seen = set()",
            "",
            "for f in os.listdir(native):",
            "    if f.lower().endswith('.dll'):",
            "        queue.append(f)",
            "        seen.add(f.lower())",
            "",
            "while queue:",
            "    cur = queue.popleft()",
            "    cur_path = os.path.join(native, cur)",
            "    try:",
            "        deps = imports(cur_path)",
            "    except Exception:",
            "        continue",
            "    for dep in deps:",
            "        if (not dep) or is_system(dep) or is_forbidden(dep):",
            "            continue",
            "        key = dep.lower()",
            "        if key in seen:",
            "            continue",
            "        src = find_dll(dep)",
            "        if not src:",
            "            raise RuntimeError(f'Missing dependency: {dep} (referenced by {cur})')",
            "        base = os.path.basename(src)",
            "        if is_forbidden(base):",
            "            continue",
            "        dst = os.path.join(native, base)",
            "        if not os.path.isfile(dst):",
            "            with open(src, 'rb') as r, open(dst, 'wb') as w:",
            "                w.write(r.read())",
            "        seen.add(base.lower())",
            "        queue.append(base)",
            "",
            "dll_count = len([x for x in os.listdir(native) if x.lower().endswith('.dll')])",
            "print('Dependency closure complete. DLL count =', dll_count)"
          )
          Set-Content -Path $pyFile -Value $pyLines -Encoding UTF8
          python $pyFile

          Compress-Archive -Path "$pkgRoot\*" -DestinationPath "$env:GITHUB_WORKSPACE\win-x64-pkg.zip" -Force

      - name: "Upload win-x64 payload"
        uses: actions/upload-artifact@v4
        with:
          name: win-x64-pkg
          path: win-x64-pkg.zip

  build-osx-x64:
    runs-on: macos-15-intel
    defaults:
      run:
        shell: bash
    steps:
      - name: "Setup Python"
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: "Install build tools"
        run: |
          set -euxo pipefail
          brew update
          brew install ninja cmake

      - name: "Clone OpenVINO (tag 2023.1.0)"
        run: |
          set -euxo pipefail
          git clone --branch "${OPENVINO_TAG}" --depth 1 --recurse-submodules https://github.com/openvinotoolkit/openvino.git openvino

      - name: "Build & Install OpenVINO (osx-x64, 10.15, CPU only, no Python)"
        env:
          MACOSX_DEPLOYMENT_TARGET: "10.15"
        run: |
          set -euxo pipefail
          cd openvino
          unset TBBROOT OpenCV_DIR || true
          mkdir -p build && cd build
          cmake .. -G "Ninja Multi-Config" \
            -DCMAKE_OSX_DEPLOYMENT_TARGET=10.15 \
            -DCMAKE_OSX_ARCHITECTURES=x86_64 \
            -DCMAKE_INSTALL_PREFIX="$PWD/ov_install" \
            -DENABLE_PYTHON=OFF -DENABLE_WHEEL=OFF \
            -DENABLE_TESTS=OFF -DENABLE_SAMPLES=OFF \
            -DENABLE_INTEL_GPU=OFF
          cmake --build . --config Release --parallel "$(sysctl -n hw.ncpu)"
          cmake --install . --config Release
          echo "$PWD/ov_install" > "$GITHUB_WORKSPACE/ov_install_osx.txt"

      - name: "Clone ONNX Runtime (tag v1.16.0)"
        run: |
          set -euxo pipefail
          git clone --branch "${ORT_TAG}" --depth 1 --recurse-submodules https://github.com/microsoft/onnxruntime.git onnxruntime
          python -m pip install --upgrade pip
          python -m pip install numpy

      - name: "Build ORT OpenVINO EP provider (osx-x64, CPU)"
        env:
          MACOSX_DEPLOYMENT_TARGET: "10.15"
        run: |
          set -euxo pipefail
          ov="$(cat "$GITHUB_WORKSPACE/ov_install_osx.txt")"
          ov_config_dir="$(dirname "$(find "$ov" -name OpenVINOConfig.cmake | head -n 1)")"
          export INTEL_OPENVINO_DIR="$ov"
          export OpenVINO_DIR="$ov_config_dir"
          cd onnxruntime
          ./build.sh --config Release --build_shared_lib --parallel --skip_tests --use_openvino CPU --update --build

      - name: "Stage minimal osx-x64 native payload (no libonnxruntime*, dependency closure + @loader_path)"
        env:
          MACOSX_DEPLOYMENT_TARGET: "10.15"
        run: |
          set -euxo pipefail

          stage_sh="$GITHUB_WORKSPACE/stage_osx.sh"
          cat > "$stage_sh" << 'EOS'
          set -euxo pipefail

          pkg_root="$GITHUB_WORKSPACE/pkg"
          native="$pkg_root/runtimes/osx-x64/native"
          mkdir -p "$native"

          ov="$(cat "$GITHUB_WORKSPACE/ov_install_osx.txt")"

          prov="$(find "$GITHUB_WORKSPACE/onnxruntime" -name 'libonnxruntime_providers_openvino.dylib' | head -n 1)"
          test -f "$prov"
          cp -f "$prov" "$native/"

          for n in \
            libopenvino.dylib \
            libopenvino_c.dylib \
            libopenvino_intel_cpu_plugin.dylib \
            libopenvino_auto_plugin.dylib \
            libopenvino_multi_plugin.dylib \
            libopenvino_hetero_plugin.dylib \
            libopenvino_batch_plugin.dylib
          do
            f="$(find "$ov" -name "$n" | head -n 1 || true)"
            if [ -n "$f" ] && [ -f "$f" ]; then
              cp -f "$f" "$native/"
            fi
          done

          {
            echo "<ie>"
            echo "  <plugins>"
            [ -f "$native/libopenvino_intel_cpu_plugin.dylib" ] && echo "    <plugin name=\"CPU\" location=\"libopenvino_intel_cpu_plugin.dylib\"></plugin>"
            [ -f "$native/libopenvino_auto_plugin.dylib" ] && echo "    <plugin name=\"AUTO\" location=\"libopenvino_auto_plugin.dylib\"></plugin>"
            [ -f "$native/libopenvino_multi_plugin.dylib" ] && echo "    <plugin name=\"MULTI\" location=\"libopenvino_multi_plugin.dylib\"></plugin>"
            [ -f "$native/libopenvino_hetero_plugin.dylib" ] && echo "    <plugin name=\"HETERO\" location=\"libopenvino_hetero_plugin.dylib\"></plugin>"
            [ -f "$native/libopenvino_batch_plugin.dylib" ] && echo "    <plugin name=\"BATCH\" location=\"libopenvino_batch_plugin.dylib\"></plugin>"
            echo "  </plugins>"
            echo "</ie>"
          } > "$native/plugins.xml"

          changed=1
          while [ $changed -eq 1 ]; do
            changed=0
            for lib in "$native"/*.dylib; do
              [ -f "$lib" ] || continue
              while read -r dep _; do
                [ -z "$dep" ] && continue
                case "$dep" in /System/*|/usr/lib/*) continue ;; esac
                base="$(basename "$dep")"
                [[ "$base" == libonnxruntime* ]] && continue
                [ -f "$native/$base" ] && continue
                src="$(find "$ov" -name "$base" | head -n 1 || true)"
                if [ -n "$src" ] && [ -f "$src" ]; then
                  cp -f "$src" "$native/$base"
                  changed=1
                else
                  echo "Missing dependency: $dep (referenced by $(basename "$lib"))"
                  exit 1
                fi
              done < <(otool -L "$lib" | tail -n +2)
            done
          done

          for lib in "$native"/*.dylib; do
            install_name_tool -id "@rpath/$(basename "$lib")" "$lib" || true
            install_name_tool -add_rpath "@loader_path" "$lib" || true
          done

          for lib in "$native"/*.dylib; do
            while read -r dep _; do
              [ -z "$dep" ] && continue
              base="$(basename "$dep")"
              if [ -f "$native/$base" ]; then
                install_name_tool -change "$dep" "@loader_path/$base" "$lib" || true
              fi
            done < <(otool -L "$lib" | tail -n +2)
          done

          strip -x "$native"/*.dylib || true
          ditto -c -k --sequesterRsrc --keepParent "$pkg_root" "$GITHUB_WORKSPACE/osx-x64-pkg.zip"
          EOS

          chmod +x "$stage_sh"
          bash "$stage_sh"

      - name: "Upload osx-x64 payload"
        uses: actions/upload-artifact@v4
        with:
          name: osx-x64-pkg
          path: osx-x64-pkg.zip

  pack-nuget:
    runs-on: ubuntu-latest
    needs: [build-win-x64, build-osx-x64]
    steps:
      - name: "Download artifacts"
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: "Merge payloads"
        run: |
          set -euxo pipefail
          mkdir -p nuget_root
          unzip -q "artifacts/win-x64-pkg/win-x64-pkg.zip" -d nuget_root
          unzip -q "artifacts/osx-x64-pkg/osx-x64-pkg.zip" -d nuget_root
          test -d "nuget_root/pkg/runtimes/win-x64/native"
          test -d "nuget_root/pkg/runtimes/osx-x64/native"

      - name: "Create packing project"
        run: |
          set -euxo pipefail
          cd nuget_root/pkg
          cat > "${PACKAGE_ID}.csproj" << EOF
          <Project Sdk="Microsoft.NET.Sdk">
            <PropertyGroup>
              <TargetFramework>netstandard2.0</TargetFramework>
              <PackageId>${PACKAGE_ID}</PackageId>
              <Version>${PACKAGE_VERSION}</Version>
              <Authors>Custom Build</Authors>
              <Description>OpenVINO EP provider + minimal OpenVINO runtime (OpenVINO ${OPENVINO_TAG}, ORT ${PACKAGE_VERSION}). win-x64 (Intel iGPU plugin enabled), osx-x64 (CPU). Does NOT include onnxruntime native library.</Description>
              <PackageRequireLicenseAcceptance>false</PackageRequireLicenseAcceptance>
              <IncludeBuildOutput>false</IncludeBuildOutput>
              <GeneratePackageOnBuild>true</GeneratePackageOnBuild>
            </PropertyGroup>
            <ItemGroup>
              <PackageReference Include="Microsoft.ML.OnnxRuntime.Managed" Version="${ORT_MANAGED_DEP_VERSION}" />
            </ItemGroup>
            <ItemGroup>
              <None Include="runtimes/**" Pack="true" PackagePath="runtimes/" />
            </ItemGroup>
          </Project>
          EOF

      - name: "Pack nupkg"
        run: |
          set -euxo pipefail
          dotnet pack "nuget_root/pkg/${PACKAGE_ID}.csproj" -c Release -o out

      - name: "Upload NuGet package"
        uses: actions/upload-artifact@v4
        with:
          name: nuget
          path: out/*.nupkg
