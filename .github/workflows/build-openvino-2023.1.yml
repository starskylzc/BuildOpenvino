name: "build-openvino-2023.1.0-ort-1.16.0-openvinoep-nuget-no-ort-native"

'on': { workflow_dispatch: {} }

env:
  OPENVINO_TAG: "2023.1.0"
  ORT_TAG: "v1.16.0"
  CONFIG: "Release"

  # OpenVINO official prebuilt packages (2023.1.0 / build 12185.47b736f63ed)
  OPENVINO_WIN_URL: "https://storage.openvinotoolkit.org/repositories/openvino/packages/2023.1/windows/w_openvino_toolkit_windows_2023.1.0.12185.47b736f63ed_x86_64.zip"
  OPENVINO_OSX_URL: "https://storage.openvinotoolkit.org/repositories/openvino/packages/2023.1/macos/m_openvino_toolkit_macos_10_15_2023.1.0.12185.47b736f63ed_x86_64.tgz"

  PACKAGE_ID: "Intel.ML.OnnxRuntime.Openvino"
  PACKAGE_VERSION: "1.16.0"
  ORT_MANAGED_DEP_VERSION: "1.16.0"

  MACOSX_DEPLOYMENT_TARGET: "10.15"

jobs:
  build-win-x64:
    runs-on: windows-2022
    defaults:
      run:
        shell: pwsh
    steps:
      - name: "Setup Python (ORT build + dep closure)"
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: "Install tools (ninja, vcpkg opencl, python deps)"
        run: |
          $ErrorActionPreference="Stop"
          choco install ninja -y
          git clone --depth 1 https://github.com/microsoft/vcpkg.git vcpkg
          .\vcpkg\bootstrap-vcpkg.bat
          .\vcpkg\vcpkg.exe install opencl:x64-windows
          python -m pip install --upgrade pip
          python -m pip install pefile numpy

      - name: "Download & Extract OpenVINO prebuilt (win-x64)"
        run: |
          $ErrorActionPreference="Stop"
          $zip = Join-Path $env:GITHUB_WORKSPACE "openvino_win.zip"
          Invoke-WebRequest -Uri $env:OPENVINO_WIN_URL -OutFile $zip
          $dst = Join-Path $env:GITHUB_WORKSPACE "openvino_pkg"
          New-Item -ItemType Directory -Force -Path $dst | Out-Null
          Expand-Archive -Path $zip -DestinationPath $dst -Force

          $root = Get-ChildItem -Path $dst -Directory | Select-Object -First 1
          if (!$root) { throw "OpenVINO root folder not found after unzip." }

          $ovRoot = $root.FullName
          $ovBin  = Join-Path $ovRoot "runtime\bin\intel64\Release"
          $ovCmake= Join-Path $ovRoot "runtime\cmake"
          $ovTbb  = Join-Path $ovRoot "runtime\3rdparty\tbb\bin"

          if (!(Test-Path $ovBin))   { throw "OpenVINO bin not found: $ovBin" }
          if (!(Test-Path $ovCmake)) { throw "OpenVINO cmake not found: $ovCmake" }
          if (!(Test-Path $ovTbb))   { throw "OpenVINO tbb bin not found: $ovTbb" }

          Add-Content $env:GITHUB_ENV "OV_ROOT_WIN=$ovRoot"
          Add-Content $env:GITHUB_ENV "OV_BIN_WIN=$ovBin"
          Add-Content $env:GITHUB_ENV "OV_CMAKE_WIN=$ovCmake"
          Add-Content $env:GITHUB_ENV "OV_TBB_BIN_WIN=$ovTbb"

      - name: "Clone ONNX Runtime (tag v1.16.0)"
        run: |
          $ErrorActionPreference="Stop"
          git clone --branch $env:ORT_TAG --depth 1 --recurse-submodules https://github.com/microsoft/onnxruntime.git onnxruntime

      - name: "Build ORT OpenVINO EP provider (win-x64, Intel iGPU target via OpenVINO GPU_FP32)"
        run: |
          $ErrorActionPreference="Stop"
          $env:INTEL_OPENVINO_DIR = $env:OV_ROOT_WIN
          $env:OpenVINO_DIR       = $env:OV_CMAKE_WIN

          cd onnxruntime
          .\build.bat --config $env:CONFIG --build_shared_lib --parallel --skip_tests --use_openvino GPU_FP32 --update --build --cmake_generator "Visual Studio 17 2022"

      - name: "Stage minimal win-x64 native payload (no onnxruntime*.dll, dep-closure BFS)"
        run: |
          $ErrorActionPreference="Stop"

          $pkgRoot = Join-Path $env:GITHUB_WORKSPACE "pkg"
          $native  = Join-Path $pkgRoot "runtimes\win-x64\native"
          New-Item -ItemType Directory -Force -Path $native | Out-Null

          $vcpkgBin = Join-Path "$env:GITHUB_WORKSPACE\vcpkg" "installed\x64-windows\bin"

          # Provider ONLY
          $prov = Get-ChildItem -Path "$env:GITHUB_WORKSPACE\onnxruntime" -Recurse -Filter "onnxruntime_providers_openvino.dll" | Select-Object -First 1
          if (!$prov) { throw "onnxruntime_providers_openvino.dll not found" }
          Copy-Item $prov.FullName $native -Force

          # Seed: OpenVINO core + needed plugins (真实文件名以官方包为准)
          $ovBin = $env:OV_BIN_WIN
          $seedNames = @(
            "openvino.dll",
            "openvino_c.dll",
            "openvino_intel_cpu_plugin.dll",
            "openvino_intel_gpu_plugin.dll",
            "openvino_auto_plugin.dll",
            "openvino_auto_batch_plugin.dll",
            "openvino_hetero_plugin.dll"
          )
          foreach ($name in $seedNames) {
            $src = Join-Path $ovBin $name
            if (Test-Path $src) { Copy-Item $src $native -Force }
          }

          # cache.json (GPU 插件常用)
          $cacheJson = Join-Path $ovBin "cache.json"
          if (Test-Path $cacheJson) { Copy-Item $cacheJson $native -Force }

          # OpenCL ICD Loader runtime (让 GPU 插件能 Load OpenCL.dll；真正算力仍依赖用户安装 Intel 驱动)
          $openclDll = Join-Path $vcpkgBin "OpenCL.dll"
          if (Test-Path $openclDll) { Copy-Item $openclDll $native -Force }

          # 可选：生成 plugins.xml（不依赖官方包里那个只含 NPU 的 plugins.xml）
          $pluginsXml = Join-Path $native "plugins.xml"
          $lines = New-Object System.Collections.Generic.List[string]
          $lines.Add("<ie>")
          $lines.Add("  <plugins>")
          if (Test-Path (Join-Path $native "openvino_intel_cpu_plugin.dll")) { $lines.Add("    <plugin name=`"CPU`" location=`"openvino_intel_cpu_plugin.dll`"></plugin>") }
          if (Test-Path (Join-Path $native "openvino_intel_gpu_plugin.dll")) { $lines.Add("    <plugin name=`"GPU`" location=`"openvino_intel_gpu_plugin.dll`"></plugin>") }
          if (Test-Path (Join-Path $native "openvino_auto_plugin.dll")) { $lines.Add("    <plugin name=`"AUTO`" location=`"openvino_auto_plugin.dll`"></plugin>") }
          if (Test-Path (Join-Path $native "openvino_auto_batch_plugin.dll")) { $lines.Add("    <plugin name=`"BATCH`" location=`"openvino_auto_batch_plugin.dll`"></plugin>") }
          if (Test-Path (Join-Path $native "openvino_hetero_plugin.dll")) { $lines.Add("    <plugin name=`"HETERO`" location=`"openvino_hetero_plugin.dll`"></plugin>") }
          $lines.Add("  </plugins>")
          $lines.Add("</ie>")
          $lines -join "`r`n" | Out-File -FilePath $pluginsXml -Encoding utf8

          # Dependency closure BFS (YAML-safe: write script file then run)
          $pyFile = Join-Path $env:GITHUB_WORKSPACE "dep_closure_win.py"
          $ovTbb  = $env:OV_TBB_BIN_WIN

          $pyLines = @(
            "import os",
            "import pefile",
            "from collections import deque",
            "",
            "native = r'''$native'''",
            "scan_dirs = [r'''$native''', r'''$vcpkgBin''', r'''$ovBin''', r'''$ovTbb''']",
            "",
            "def is_system(name):",
            "    u = name.upper()",
            "    sys_prefix = (",
            "        'KERNEL32','KERNELBASE','USER32','GDI32','ADVAPI32','SHELL32','OLE32','OLEAUT32','WS2_32','IPHLPAPI',",
            "        'CRYPT32','COMDLG32','SHLWAPI','NTDLL','VERSION',",
            "        'MSVCRT','VCRUNTIME','UCRTBASE','MSVCP','CONCRT','VCOMP',",
            "        'api-ms-win-','ext-ms-win-'",
            "    )",
            "    return u.startswith(sys_prefix)",
            "",
            "def is_forbidden(name):",
            "    return name.lower().startswith('onnxruntime')",
            "",
            "def find_dll(name):",
            "    p = os.path.join(native, name)",
            "    if os.path.isfile(p):",
            "        return p",
            "    for d in scan_dirs:",
            "        for root, _, files in os.walk(d):",
            "            for f in files:",
            "                if f.lower() == name.lower():",
            "                    return os.path.join(root, f)",
            "    return None",
            "",
            "def imports(dll_path):",
            "    pe = pefile.PE(dll_path)",
            "    deps = []",
            "    if hasattr(pe, 'DIRECTORY_ENTRY_IMPORT'):",
            "        for entry in pe.DIRECTORY_ENTRY_IMPORT:",
            "            deps.append(entry.dll.decode(errors='ignore'))",
            "    return deps",
            "",
            "queue = deque()",
            "seen = set()",
            "for f in os.listdir(native):",
            "    if f.lower().endswith('.dll'):",
            "        queue.append(f)",
            "        seen.add(f.lower())",
            "",
            "while queue:",
            "    cur = queue.popleft()",
            "    cur_path = os.path.join(native, cur)",
            "    try:",
            "        deps = imports(cur_path)",
            "    except Exception:",
            "        continue",
            "    for dep in deps:",
            "        if (not dep) or is_system(dep) or is_forbidden(dep):",
            "            continue",
            "        key = dep.lower()",
            "        if key in seen:",
            "            continue",
            "        src = find_dll(dep)",
            "        if not src:",
            "            raise RuntimeError(f'Missing dependency: {dep} (referenced by {cur})')",
            "        base = os.path.basename(src)",
            "        if is_forbidden(base) or is_system(base):",
            "            continue",
            "        dst = os.path.join(native, base)",
            "        if not os.path.isfile(dst):",
            "            with open(src, 'rb') as r, open(dst, 'wb') as w:",
            "                w.write(r.read())",
            "        seen.add(base.lower())",
            "        queue.append(base)",
            "",
            "dll_count = len([x for x in os.listdir(native) if x.lower().endswith('.dll')])",
            "print('Dependency closure complete. DLL count =', dll_count)"
          )
          Set-Content -Path $pyFile -Value $pyLines -Encoding UTF8
          python $pyFile

          Compress-Archive -Path "$pkgRoot\*" -DestinationPath "$env:GITHUB_WORKSPACE\win-x64-pkg.zip" -Force

      - name: "Upload win-x64 payload"
        uses: actions/upload-artifact@v4
        with:
          name: win-x64-pkg
          path: win-x64-pkg.zip

  build-osx-x64:
    runs-on: macos-15-intel
    defaults:
      run:
        shell: bash
    steps:
      - name: "Setup Python (ORT build)"
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: "Install build tools"
        run: |
          set -euxo pipefail
          brew update
          brew install cmake ninja

      - name: "Download & Extract OpenVINO prebuilt (macos x86_64, 10.15)"
        env:
          MACOSX_DEPLOYMENT_TARGET: "10.15"
        run: |
          set -euxo pipefail
          curl -L "${OPENVINO_OSX_URL}" -o openvino_osx.tgz
          mkdir -p openvino_pkg
          tar -xzf openvino_osx.tgz -C openvino_pkg
          root="$(find openvino_pkg -maxdepth 1 -type d -mindepth 1 | head -n 1)"
          test -n "${root}"
          ov_root="$(cd "${root}" && pwd)"
          ov_lib="${ov_root}/runtime/lib/intel64/Release"
          ov_cmake="${ov_root}/runtime/cmake"
          ov_tbb="${ov_root}/runtime/3rdparty/tbb/lib"
          test -d "${ov_lib}"
          test -d "${ov_cmake}"
          test -d "${ov_tbb}"
          echo "OV_ROOT_OSX=${ov_root}" >> "${GITHUB_ENV}"
          echo "OV_LIB_OSX=${ov_lib}" >> "${GITHUB_ENV}"
          echo "OV_CMAKE_OSX=${ov_cmake}" >> "${GITHUB_ENV}"
          echo "OV_TBB_LIB_OSX=${ov_tbb}" >> "${GITHUB_ENV}"

      - name: "Clone ONNX Runtime (tag v1.16.0) + python deps"
        run: |
          set -euxo pipefail
          git clone --branch "${ORT_TAG}" --depth 1 --recurse-submodules https://github.com/microsoft/onnxruntime.git onnxruntime
          python -m pip install --upgrade pip
          python -m pip install numpy

      - name: "Build ORT OpenVINO EP provider (osx-x64, CPU_FP32, deploy 10.15)"
        env:
          MACOSX_DEPLOYMENT_TARGET: "10.15"
        run: |
          set -euxo pipefail
          export INTEL_OPENVINO_DIR="${OV_ROOT_OSX}"
          export OpenVINO_DIR="${OV_CMAKE_OSX}"
          cd onnxruntime
          ./build.sh --config Release --build_shared_lib --parallel --skip_tests --use_openvino CPU_FP32 --osx_arch x86_64 --apple_deploy_target 10.15 --update --build

      - name: "Stage minimal osx-x64 native payload (no libonnxruntime*, dep-closure + @loader_path)"
        env:
          MACOSX_DEPLOYMENT_TARGET: "10.15"
        run: |
          set -euxo pipefail

          pkg_root="$GITHUB_WORKSPACE/pkg"
          native="$pkg_root/runtimes/osx-x64/native"
          mkdir -p "$native"

          # Provider ONLY
          prov="$(find "$GITHUB_WORKSPACE/onnxruntime" -name 'libonnxruntime_providers_openvino.dylib' | head -n 1)"
          test -f "$prov"
          cp -f "$prov" "$native/"

          ovlib="${OV_LIB_OSX}"
          ov_tbb="${OV_TBB_LIB_OSX}"

          # Seed OpenVINO core dylibs (包含版本化名字，避免依赖缺失)
          for f in "$ovlib"/libopenvino*.dylib "$ovlib"/libopenvino_c*.dylib; do
            if [ -f "$f" ]; then cp -f "$f" "$native/"; fi
          done

          # Seed plugins we actually need (官方包真实文件名)
          for f in \
            "$ovlib/libopenvino_intel_cpu_plugin.so" \
            "$ovlib/libopenvino_auto_plugin.so" \
            "$ovlib/libopenvino_auto_batch_plugin.so" \
            "$ovlib/libopenvino_hetero_plugin.so"
          do
            if [ -f "$f" ]; then cp -f "$f" "$native/"; fi
          done

          # Dependency closure (otool -L) for both .dylib and .so, exclude libonnxruntime*
          shopt -s nullglob
          changed=1
          while [ $changed -eq 1 ]; do
            changed=0
            for lib in "$native"/*.dylib "$native"/*.so; do
              [ -f "$lib" ] || continue
              while read -r dep; do
                [ -z "$dep" ] && continue
                case "$dep" in /System/*|/usr/lib/*) continue ;; esac
                base="$(basename "$dep")"
                [[ "$base" == libonnxruntime* ]] && continue
                [ -f "$native/$base" ] && continue

                src=""
                if [ -f "$ovlib/$base" ]; then
                  src="$ovlib/$base"
                elif [ -f "$ov_tbb/$base" ]; then
                  src="$ov_tbb/$base"
                else
                  # fallback: search within those dirs
                  src="$(find "$ovlib" "$ov_tbb" -maxdepth 1 -name "$base" -print -quit || true)"
                fi

                if [ -n "$src" ] && [ -f "$src" ]; then
                  cp -f "$src" "$native/$base"
                  changed=1
                else
                  echo "Missing dependency: $dep (referenced by $(basename "$lib"))"
                  exit 1
                fi
              done < <(otool -L "$lib" | tail -n +2 | awk '{print $1}')
            done
          done

          # Patch to @loader_path to avoid DYLD_LIBRARY_PATH
          for lib in "$native"/*.dylib "$native"/*.so; do
            [ -f "$lib" ] || continue
            install_name_tool -id "@rpath/$(basename "$lib")" "$lib" || true
            install_name_tool -add_rpath "@loader_path" "$lib" || true
          done

          for lib in "$native"/*.dylib "$native"/*.so; do
            [ -f "$lib" ] || continue
            while read -r dep; do
              [ -z "$dep" ] && continue
              case "$dep" in /System/*|/usr/lib/*) continue ;; esac
              base="$(basename "$dep")"
              if [ -f "$native/$base" ]; then
                install_name_tool -change "$dep" "@loader_path/$base" "$lib" || true
              fi
            done < <(otool -L "$lib" | tail -n +2 | awk '{print $1}')
          done

          strip -x "$native"/*.dylib "$native"/*.so || true
          ditto -c -k --sequesterRsrc --keepParent "$pkg_root" "$GITHUB_WORKSPACE/osx-x64-pkg.zip"

      - name: "Upload osx-x64 payload"
        uses: actions/upload-artifact@v4
        with:
          name: osx-x64-pkg
          path: osx-x64-pkg.zip

  pack-nuget:
    runs-on: ubuntu-latest
    needs: [build-win-x64, build-osx-x64]
    steps:
      - name: "Setup .NET (for packing)"
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      - name: "Download artifacts"
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: "Merge payloads"
        run: |
          set -euxo pipefail
          mkdir -p nuget_root
          unzip -q "artifacts/win-x64-pkg/win-x64-pkg.zip" -d nuget_root
          unzip -q "artifacts/osx-x64-pkg/osx-x64-pkg.zip" -d nuget_root
          test -d "nuget_root/pkg/runtimes/win-x64/native"
          test -d "nuget_root/pkg/runtimes/osx-x64/native"

      - name: "Create packing project (managed-only dependency)"
        run: |
          set -euxo pipefail
          cd nuget_root/pkg
          cat > "${PACKAGE_ID}.csproj" << EOF
          <Project Sdk="Microsoft.NET.Sdk">
            <PropertyGroup>
              <TargetFramework>netstandard2.0</TargetFramework>
              <PackageId>${PACKAGE_ID}</PackageId>
              <Version>${PACKAGE_VERSION}</Version>
              <Authors>Custom Build</Authors>
              <Description>OpenVINO EP provider + minimal OpenVINO runtime (OpenVINO ${OPENVINO_TAG}, ORT ${PACKAGE_VERSION}). win-x64: Intel iGPU (OpenVINO GPU plugin). osx-x64: CPU. Does NOT include onnxruntime native library.</Description>
              <PackageRequireLicenseAcceptance>false</PackageRequireLicenseAcceptance>
              <IncludeBuildOutput>false</IncludeBuildOutput>
              <GeneratePackageOnBuild>true</GeneratePackageOnBuild>
            </PropertyGroup>
            <ItemGroup>
              <PackageReference Include="Microsoft.ML.OnnxRuntime.Managed" Version="${ORT_MANAGED_DEP_VERSION}" />
            </ItemGroup>
            <ItemGroup>
              <None Include="runtimes/**" Pack="true" PackagePath="runtimes/" />
            </ItemGroup>
          </Project>
          EOF

      - name: "Pack nupkg"
        run: |
          set -euxo pipefail
          dotnet pack "nuget_root/pkg/${PACKAGE_ID}.csproj" -c Release -o out

      - name: "Upload NuGet package"
        uses: actions/upload-artifact@v4
        with:
          name: nuget
          path: out/*.nupkg
