name: Build Minimal OpenCvSharpExtern (Fixed)

on:
  workflow_dispatch:

jobs:
  build-arch:
    name: Build for ${{ matrix.arch }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: x86_64
            os: macos-15-intel
            deployment_target: "10.15"
          - arch: arm64
            os: macos-latest
            deployment_target: "11.0"

    steps:
      - name: Checkout OpenCvSharp
        uses: actions/checkout@v4
        with:
          repository: shimat/opencvsharp
          path: opencvsharp

      - name: Checkout OpenCV
        uses: actions/checkout@v4
        with:
          repository: opencv/opencv
          ref: 4.8.0  # 保持 4.8.0，通过参数修复兼容性
          path: opencv

      - name: Checkout OpenCV Contrib
        uses: actions/checkout@v4
        with:
          repository: opencv/opencv_contrib
          ref: 4.8.0
          path: opencv_contrib

      - name: Install Build Tools
        run: |
          brew install cmake ninja
          # 只安装最基础的，防止 brew 的库干扰静态编译
          brew install yasm

      - name: Configure OpenCV (Minimal Static & Fixed)
        run: |
          mkdir -p opencv/build
          cd opencv/build
          
          # 核心修复说明：
          # 1. -Wno-macro-redefined -w : 忽略 zlib 的宏定义冲突和所有警告
          # 2. WITH_CAROTENE=OFF : 修复 ARM64 编译崩溃
          # 3. WITH_IPP=OFF : 修复 x64 下旧系统兼容性
          # 4. BUILD_ZLIB=ON : 强制使用内置 zlib 并在上面应用忽略警告的 flag
          
          cmake -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_INSTALL_PREFIX=../install \
            -DCMAKE_OSX_ARCHITECTURES=${{ matrix.arch }} \
            -DCMAKE_OSX_DEPLOYMENT_TARGET=${{ matrix.deployment_target }} \
            -DCMAKE_C_FLAGS="-w -Wno-macro-redefined -Wno-everything" \
            -DCMAKE_CXX_FLAGS="-w -Wno-macro-redefined -Wno-everything" \
            \
            -DBUILD_SHARED_LIBS=OFF \
            -DOPENCV_EXTRA_MODULES_PATH=../../opencv_contrib/modules \
            \
            -DBUILD_opencv_apps=OFF \
            -DBUILD_opencv_python3=OFF \
            -DBUILD_opencv_java=OFF \
            -DBUILD_opencv_world=OFF \
            \
            -DBUILD_opencv_dnn=OFF \
            -DBUILD_opencv_ml=OFF \
            -DBUILD_opencv_flann=OFF \
            -DBUILD_opencv_photo=OFF \
            -DBUILD_opencv_stitching=OFF \
            -DBUILD_opencv_gapi=OFF \
            -DBUILD_opencv_highgui=OFF \
            -DBUILD_opencv_calib3d=OFF \
            -DBUILD_opencv_features2d=OFF \
            -DBUILD_opencv_objdetect=OFF \
            -DBUILD_opencv_video=OFF \
            \
            -DBUILD_ZLIB=ON \
            -DBUILD_JPEG=ON \
            -DBUILD_PNG=ON \
            -DBUILD_TIFF=ON \
            -DBUILD_WEBP=ON \
            -DBUILD_OPENEXR=ON \
            \
            -DWITH_FFMPEG=ON \
            -DWITH_FREETYPE=ON \
            -DWITH_HARFBUZZ=ON \
            -DWITH_CAROTENE=OFF \
            -DWITH_IPP=OFF \
            -DWITH_LAPACK=OFF \
            -DWITH_EIGEN=OFF \
            -DWITH_OPENCL=OFF \
            -DWITH_ITT=OFF \
            -DWITH_JASPER=OFF \
            -DWITH_OPENJPEG=OFF \
            ..

      - name: Build OpenCV Static
        run: |
          cd opencv/build
          ninja
          ninja install

      - name: Configure OpenCvSharpExtern
        run: |
          mkdir -p opencvsharp/src/OpenCvSharpExtern/build
          cd opencvsharp/src/OpenCvSharpExtern/build
          
          # 同样加上忽略警告的 flag
          cmake -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_OSX_ARCHITECTURES=${{ matrix.arch }} \
            -DCMAKE_OSX_DEPLOYMENT_TARGET=${{ matrix.deployment_target }} \
            -DCMAKE_C_FLAGS="-w" \
            -DCMAKE_CXX_FLAGS="-w" \
            -DOpenCV_DIR=$(pwd)/../../../../opencv/build/install/lib/cmake/opencv4 \
            ..

      - name: Build OpenCvSharpExtern
        run: |
          cd opencvsharp/src/OpenCvSharpExtern/build
          ninja

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: libOpenCvSharpExtern-${{ matrix.arch }}
          path: opencvsharp/src/OpenCvSharpExtern/build/libOpenCvSharpExtern.dylib

  create-universal-binary:
    needs: build-arch
    runs-on: macos-latest
    steps:
      - name: Download x64 Artifact
        uses: actions/download-artifact@v4
        with:
          name: libOpenCvSharpExtern-x86_64
          path: x64

      - name: Download arm64 Artifact
        uses: actions/download-artifact@v4
        with:
          name: libOpenCvSharpExtern-arm64
          path: arm64

      - name: Create Universal Binary (Lipo)
        run: |
          mkdir output
          lipo -create \
            x64/libOpenCvSharpExtern.dylib \
            arm64/libOpenCvSharpExtern.dylib \
            -output output/libOpenCvSharpExtern.dylib
            
          echo "=== Verify Architectures ==="
          lipo -info output/libOpenCvSharpExtern.dylib
          
          echo "=== Verify Dependencies ==="
          otool -L output/libOpenCvSharpExtern.dylib

      - name: Upload Final Universal Binary
        uses: actions/upload-artifact@v4
        with:
          name: libOpenCvSharpExtern-Universal
          path: output/libOpenCvSharpExtern.dylib
          
