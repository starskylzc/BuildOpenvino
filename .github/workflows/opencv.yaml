name: Build Minimal OpenCvSharpExtern (Final Fix)

on:
  workflow_dispatch:

jobs:
  build-arch:
    name: Build for ${{ matrix.arch }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: x86_64
            os: macos-15-intel
            deployment_target: "10.15"
          - arch: arm64
            os: macos-latest
            deployment_target: "11.0"

    steps:
      - name: Checkout OpenCvSharp
        uses: actions/checkout@v4
        with:
          repository: shimat/opencvsharp
          path: opencvsharp

      - name: Checkout OpenCV
        uses: actions/checkout@v4
        with:
          repository: opencv/opencv
          ref: 4.8.0
          path: opencv

      # 注意：不再需要 opencv_contrib，因为我们关掉了 freetype，纯净版不需要它

      - name: Install Build Tools
        run: |
          brew install cmake ninja
          # 不需要安装 ffmpeg 和 freetype，确保环境纯净

      - name: Configure OpenCV (Minimal & System Zlib)
        run: |
          mkdir -p opencv/build
          cd opencv/build
          
          # === 关键配置解读 ===
          # 1. BUILD_ZLIB=OFF : 使用 Mac 系统自带的 libz，解决 fdopen 报错
          # 2. WITH_FFMPEG=OFF : 摄像头走 AVFoundation，不需要 FFmpeg，去除巨大依赖
          # 3. WITH_FREETYPE=OFF : 去除 Freetype 依赖
          # 4. WITH_CAROTENE=OFF : 解决 ARM64 编译崩溃
          # 5. WITH_AVFOUNDATION=ON : 确保开启 Mac 摄像头支持
          
          cmake -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_INSTALL_PREFIX=../install \
            -DCMAKE_OSX_ARCHITECTURES=${{ matrix.arch }} \
            -DCMAKE_OSX_DEPLOYMENT_TARGET=${{ matrix.deployment_target }} \
            \
            -DBUILD_SHARED_LIBS=OFF \
            -DBUILD_opencv_apps=OFF \
            -DBUILD_opencv_python3=OFF \
            -DBUILD_opencv_java=OFF \
            -DBUILD_opencv_world=OFF \
            \
            -DBUILD_opencv_dnn=OFF \
            -DBUILD_opencv_ml=OFF \
            -DBUILD_opencv_flann=OFF \
            -DBUILD_opencv_photo=OFF \
            -DBUILD_opencv_stitching=OFF \
            -DBUILD_opencv_gapi=OFF \
            -DBUILD_opencv_highgui=OFF \
            -DBUILD_opencv_calib3d=OFF \
            -DBUILD_opencv_features2d=OFF \
            -DBUILD_opencv_objdetect=OFF \
            -DBUILD_opencv_video=OFF \
            \
            -DBUILD_ZLIB=OFF \
            -DBUILD_JPEG=ON \
            -DBUILD_PNG=ON \
            -DBUILD_TIFF=OFF \
            -DBUILD_WEBP=OFF \
            -DBUILD_OPENEXR=OFF \
            \
            -DWITH_AVFOUNDATION=ON \
            -DWITH_FFMPEG=OFF \
            -DWITH_FREETYPE=OFF \
            -DWITH_HARFBUZZ=OFF \
            -DWITH_CAROTENE=OFF \
            -DWITH_IPP=OFF \
            -DWITH_LAPACK=OFF \
            -DWITH_EIGEN=OFF \
            -DWITH_OPENCL=OFF \
            -DWITH_ITT=OFF \
            -DWITH_JASPER=OFF \
            -DWITH_OPENJPEG=OFF \
            -DWITH_QUIRC=OFF \
            ..

      - name: Build OpenCV Static
        run: |
          cd opencv/build
          ninja
          ninja install

      - name: Configure OpenCvSharpExtern
        run: |
          mkdir -p opencvsharp/src/OpenCvSharpExtern/build
          cd opencvsharp/src/OpenCvSharpExtern/build
          
          cmake -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_OSX_ARCHITECTURES=${{ matrix.arch }} \
            -DCMAKE_OSX_DEPLOYMENT_TARGET=${{ matrix.deployment_target }} \
            -DOpenCV_DIR=$(pwd)/../../../../opencv/build/install/lib/cmake/opencv4 \
            ..

      - name: Build OpenCvSharpExtern
        run: |
          cd opencvsharp/src/OpenCvSharpExtern/build
          ninja

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: libOpenCvSharpExtern-${{ matrix.arch }}
          path: opencvsharp/src/OpenCvSharpExtern/build/libOpenCvSharpExtern.dylib

  create-universal-binary:
    needs: build-arch
    runs-on: macos-latest
    steps:
      - name: Download x64 Artifact
        uses: actions/download-artifact@v4
        with:
          name: libOpenCvSharpExtern-x86_64
          path: x64

      - name: Download arm64 Artifact
        uses: actions/download-artifact@v4
        with:
          name: libOpenCvSharpExtern-arm64
          path: arm64

      - name: Create Universal Binary (Lipo)
        run: |
          mkdir output
          lipo -create \
            x64/libOpenCvSharpExtern.dylib \
            arm64/libOpenCvSharpExtern.dylib \
            -output output/libOpenCvSharpExtern.dylib
            
          echo "=== Verify Architectures ==="
          lipo -info output/libOpenCvSharpExtern.dylib
          
          echo "=== Verify Dependencies (Should ONLY contain /usr/lib/...) ==="
          otool -L output/libOpenCvSharpExtern.dylib

      - name: Upload Final Universal Binary
        uses: actions/upload-artifact@v4
        with:
          name: libOpenCvSharpExtern-Universal
          path: output/libOpenCvSharpExtern.dylib
