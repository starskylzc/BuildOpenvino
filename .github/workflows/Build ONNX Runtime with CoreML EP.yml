name: Build ORT CoreML (Specific Arch)

on:
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Build Configuration'
        required: true
        default: 'Release'
        type: choice
        options:
        - Release
        - RelWithDebInfo

jobs:
  build:
    name: Build ${{ matrix.ort_version }} (${{ matrix.arch }})
    runs-on: macos-14 # 使用 M1 运行器 (编译速度最快，支持交叉编译 x86)
    strategy:
      fail-fast: false
      matrix:
        include:
          # === 在这里定义版本和架构的对应关系 ===
          - ort_version: 'v1.16.3'
            arch: 'x86_64'
            
          - ort_version: 'v1.19.2'
            arch: 'arm64'

    steps:
      - name: Checkout ONNX Runtime
        uses: actions/checkout@v4
        with:
          repository: microsoft/onnxruntime
          ref: ${{ matrix.ort_version }}
          submodules: recursive
          fetch-depth: 1

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Dependencies
        run: |
          brew install cmake ninja
          pip install numpy

      - name: Build Shared Library
        shell: bash
        run: |
          echo ">>> Building ORT ${{ matrix.ort_version }} for ${{ matrix.arch }}..."
          
          # 直接传入对应的架构参数
          python3 tools/ci_build/build.py \
            --build_dir build \
            --config ${{ inputs.build_type }} \
            --use_coreml \
            --parallel \
            --build_shared_lib \
            --skip_tests \
            --skip_submodule_sync \
            --osx_arch ${{ matrix.arch }}

      - name: Check Output
        run: |
          # 验证生成文件的架构类型
          FILE_PATH="build/${{ inputs.build_type }}/libonnxruntime.dylib"
          ls -lh $FILE_PATH
          lipo -info $FILE_PATH

      - name: Organize Artifacts
        run: |
          mkdir -p artifacts
          cp build/${{ inputs.build_type }}/libonnxruntime*.dylib artifacts/
          
          # 尝试复制头文件
          mkdir -p artifacts/include
          if [ -d "include/onnxruntime/core/session" ]; then
             cp -r include/onnxruntime/core/session/*.h artifacts/include/
          fi
          
          # 生成版本信息文件
          echo "Version: ${{ matrix.ort_version }}" > artifacts/version.txt
          echo "Arch: ${{ matrix.arch }}" >> artifacts/version.txt
          echo "Provider: CoreML" >> artifacts/version.txt

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          # 产物名称会明确带上版本和架构，例如：
          # onnxruntime-v1.16.3-x86_64-coreml
          # onnxruntime-v1.19.2-arm64-coreml
          name: onnxruntime-${{ matrix.ort_version }}-${{ matrix.arch }}-coreml
          path: artifacts/
